<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>FoundOne — Password Reset</title>

  <!-- Prevent indexing of this utility page -->
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#667eea" />
  <meta name="color-scheme" content="light only" />

  <style>
    :root {
      --bg-start: #667eea;
      --bg-end: #764ba2;
      --glass: rgba(255, 255, 255, 0.1);
      --text: #ffffff;
      --btn: rgba(255, 255, 255, 0.2);
      --btn-hover: rgba(255, 255, 255, 0.3);
      --border: rgba(255, 255, 255, 0.3);
    }

    /* Base */
    html, body {
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px 32px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }

    .logo {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 0.3px;
      margin-bottom: 8px;
    }

    .sub {
      opacity: 0.9;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .loader {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .loader { animation: none; }
    }

    .message {
      margin: 8px 0 16px;
      line-height: 1.55;
    }

    .fallback {
      margin-top: 20px;
      padding: 18px;
      background: var(--glass);
      border-radius: 12px;
      font-size: 14px;
      display: none;
    }

    .btn {
      display: inline-block;
      background: var(--btn);
      color: var(--text);
      padding: 12px 22px;
      border-radius: 999px;
      text-decoration: none;
      margin: 10px 6px 0;
      border: 1px solid var(--border);
      transition: background 0.25s ease, transform 0.06s ease;
      touch-action: manipulation;
    }

    .btn:hover { background: var(--btn-hover); }
    .btn:active { transform: translateY(1px); }

    small { opacity: 0.9; }
    .hidden { display: none !important; }
    .sr-only {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0);
      white-space: nowrap; border: 0;
    }

    .debug {
      margin-top: 20px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
      text-align: left;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="app-title">
    <div id="app-title" class="logo">FoundOne</div>
    <div class="sub">Password recovery</div>

    <div class="loader" id="loader" role="status" aria-live="polite" aria-label="Opening the app"></div>

    <div class="message" id="message">
      Opening the FoundOne app…
    </div>

    <div class="fallback" id="fallback" aria-live="polite">
      <p id="fallbackText">Couldn't open the app automatically. Tap below to continue.</p>
      <a href="#" class="btn" id="manualOpenBtn" role="button" aria-label="Open app manually">Open App Manually</a>
      <br />
      <small>Make sure you have the FoundOne app installed.</small>
    </div>

    <div class="debug" id="debug">
      <strong>Debug Info:</strong><br>
      <span id="debugContent"></span>
    </div>

    <noscript>
      <div class="fallback" style="display:block;margin-top:16px">
        <p>JavaScript is required to complete password reset. Please enable JavaScript, then re-open your reset link.</p>
      </div>
    </noscript>
  </div>

  <script>
    (function () {
      /** Flags & timers */
      let appOpened = false;
      let attempted = false;
      let fallbackTimer = null;
      let retryOnFocus = 1;
      let debugMode = window.location.search.includes('debug=true');

      function log(message) {
        console.log('[FoundOne Reset]', message);
        if (debugMode) {
          const debugContent = document.getElementById('debugContent');
          const debug = document.getElementById('debug');
          if (debugContent && debug) {
            debugContent.innerHTML += message + '<br>';
            debug.style.display = 'block';
          }
        }
      }

      function getTokensFromUrl() {
        // Try to get tokens from URL fragment first (Supabase default)
        let fragment = window.location.hash ? window.location.hash.substring(1) : "";
        let query = window.location.search ? window.location.search.substring(1) : "";
        
        log(`Fragment: ${fragment}`);
        log(`Query: ${query}`);

        let params = {};
        
        // Parse fragment first (most common with Supabase)
        if (fragment) {
          params = Object.fromEntries(new URLSearchParams(fragment));
        }
        // Fallback to query parameters
        else if (query) {
          params = Object.fromEntries(new URLSearchParams(query));
        }

        log(`Parsed params: ${JSON.stringify(params)}`);
        return params;
      }

      function validateTokens(params) {
        const type = params.type;
        const accessToken = params.access_token;
        const refreshToken = params.refresh_token;

        log(`Type: ${type}, Access Token: ${accessToken ? 'present' : 'missing'}, Refresh Token: ${refreshToken ? 'present' : 'missing'}`);

        if (type !== "recovery") {
          return { ok: false, msg: "Invalid link type. Expected password recovery link." };
        }
        
        if (!accessToken || !refreshToken) {
          return { ok: false, msg: "Invalid reset link. Missing authentication tokens." };
        }

        return { ok: true, params: { type, access_token: accessToken, refresh_token: refreshToken } };
      }

      function createAppUrl(params) {
        // Create the fragment string for the app
        const fragment = new URLSearchParams(params).toString();
        return `foundone://reset-password#${fragment}`;
      }

      function tryOpenApp() {
        log('Starting app opening process...');
        
        const tokens = getTokensFromUrl();
        const validation = validateTokens(tokens);
        
        if (!validation.ok) {
          log(`Validation failed: ${validation.msg}`);
          showFallback(validation.msg);
          return;
        }

        const appUrl = createAppUrl(validation.params);
        log(`Generated app URL: ${appUrl}`);

        // Clear any previous attempts
        clearTimeout(fallbackTimer);
        attempted = false;

        // Create invisible iframe to trigger the app
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = appUrl;
        document.body.appendChild(iframe);
        
        log('Created iframe to trigger app...');

        // Also try direct window.location as backup
        setTimeout(() => {
          if (!attempted && !appOpened) {
            attempted = true;
            log('Attempting direct navigation...');
            window.location.href = appUrl;
          }
        }, 1000);

        // Show fallback after timeout
        fallbackTimer = setTimeout(() => {
          if (!appOpened) {
            log('Timeout reached, showing fallback...');
            showFallback("Couldn't open the app automatically. Tap below to continue.");
          }
        }, 4000);

        // Clean up iframe
        setTimeout(() => {
          if (iframe.parentNode) {
            iframe.parentNode.removeChild(iframe);
          }
        }, 5000);
      }

      function showFallback(customMessage) {
        log(`Showing fallback: ${customMessage}`);
        
        const loader = document.getElementById("loader");
        const message = document.getElementById("message");
        const fallback = document.getElementById("fallback");
        const fallbackText = document.getElementById("fallbackText");
        
        if (loader) loader.classList.add("hidden");
        if (message) message.textContent = customMessage || "Having trouble opening the app? Try the manual option below.";
        if (fallback) fallback.style.display = "block";

        // Set up manual open button
        const manualBtn = document.getElementById("manualOpenBtn");
        if (manualBtn) {
          manualBtn.onclick = function (e) {
            e.preventDefault();
            log('Manual button clicked...');
            
            const tokens = getTokensFromUrl();
            const validation = validateTokens(tokens);
            
            if (!validation.ok) {
              if (fallbackText) fallbackText.textContent = validation.msg;
              log(`Manual validation failed: ${validation.msg}`);
              return;
            }
            
            const appUrl = createAppUrl(validation.params);
            log(`Manual app URL: ${appUrl}`);
            window.location.href = appUrl;
          };
        }
      }

      // Detect if app opened (page becomes hidden)
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          log('Page became hidden - app likely opened');
          appOpened = true;
          clearTimeout(fallbackTimer);
        }
      });

      // Detect page blur (another way to detect app switch)
      window.addEventListener("blur", function () {
        log('Window blurred - app might have opened');
        setTimeout(() => {
          if (!document.hasFocus()) {
            appOpened = true;
            clearTimeout(fallbackTimer);
          }
        }, 100);
      });

      // Start when page loads
      window.addEventListener("load", function() {
        log('Page loaded, starting process...');
        // Small delay to ensure everything is ready
        setTimeout(tryOpenApp, 500);
      });

      // Retry when user returns focus (e.g., after installing app)
      window.addEventListener("focus", function () {
        if (!appOpened && retryOnFocus > 0) {
          retryOnFocus -= 1;
          log('Page focused, retrying app open...');
          tryOpenApp();
        }
      });

      // Expose debug function globally
      window.enableDebug = function() {
        debugMode = true;
        document.getElementById('debug').style.display = 'block';
      };
    })();
  </script>
</body>
</html>