<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>FoundOne — Password Reset</title>

  <!-- Prevent indexing of this utility page -->
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#667eea" />
  <meta name="color-scheme" content="light only" />

  <style>
    :root {
      --bg-start: #667eea;
      --bg-end: #764ba2;
      --glass: rgba(255, 255, 255, 0.1);
      --text: #ffffff;
      --btn: rgba(255, 255, 255, 0.2);
      --btn-hover: rgba(255, 255, 255, 0.3);
      --border: rgba(255, 255, 255, 0.3);
    }

    /* Base */
    html, body {
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px 32px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }

    .logo {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 0.3px;
      margin-bottom: 8px;
    }

    .sub {
      opacity: 0.9;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .loader {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .loader { animation: none; }
    }

    .message {
      margin: 8px 0 16px;
      line-height: 1.55;
    }

    .fallback {
      margin-top: 20px;
      padding: 18px;
      background: var(--glass);
      border-radius: 12px;
      font-size: 14px;
      display: none;
    }

    .btn {
      display: inline-block;
      background: var(--btn);
      color: var(--text);
      padding: 12px 22px;
      border-radius: 999px;
      text-decoration: none;
      margin: 10px 6px 0;
      border: 1px solid var(--border);
      transition: background 0.25s ease, transform 0.06s ease;
      touch-action: manipulation;
    }

    .btn:hover { background: var(--btn-hover); }
    .btn:active { transform: translateY(1px); }

    small { opacity: 0.9; }
    .hidden { display: none !important; }
    .sr-only {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0);
      white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="app-title">
    <div id="app-title" class="logo">FoundOne</div>
    <div class="sub">Password recovery</div>

    <div class="loader" id="loader" role="status" aria-live="polite" aria-label="Opening the app"></div>

    <div class="message" id="message">
      Opening the FoundOne app…
    </div>

    <div class="fallback" id="fallback" aria-live="polite">
      <p id="fallbackText">Couldn’t open the app automatically. Tap below to continue.</p>
      <a href="#" class="btn" id="manualOpenBtn" role="button" aria-label="Open app manually">Open App Manually</a>
      <br />
      <small>Make sure you have the FoundOne app installed.</small>
    </div>

    <noscript>
      <div class="fallback" style="display:block;margin-top:16px">
        <p>JavaScript is required to complete password reset. Please enable JavaScript, then re-open your reset link.</p>
      </div>
    </noscript>
  </div>

  <script>
    (function () {
      /** Flags & timers */
      let appOpened = false;     // page turned hidden → likely app opened
      let attempted = false;     // guard to avoid multiple navigations
      let fallbackTimer = null;  // timer to reveal fallback
      let retryOnFocus = 1;      // one extra retry when user returns focus

      function getFragment() {
        // Supabase sends tokens in the URL fragment (#…)
        return window.location.hash ? window.location.hash.substring(1) : "";
      }

      function validateFragment(fragment) {
        if (!fragment) return { ok: false, msg: "Invalid reset link. Please request a new password reset." };
        const params = new URLSearchParams(fragment);
        const type = params.get("type");
        const accessToken = params.get("access_token");
        const refreshToken = params.get("refresh_token");
        if (type !== "recovery" || !accessToken || !refreshToken) {
          return { ok: false, msg: "Invalid reset link format. Please request a new password reset." };
        }
        return { ok: true, params };
      }

      function tryOpenApp() {
        const fragment = getFragment();
        const result = validateFragment(fragment);
        if (!result.ok) {
          showFallback(result.msg);
          return;
        }

        // Attempt native deep link first, then HTTPS handoff route
        const schemes = [
          `foundone://reset-password#${fragment}`,
          `https://found-one.vercel.app/reset-password#${fragment}`
        ];

        // Clear any previous timers/attempt state
        clearTimeout(fallbackTimer);
        attempted = false;

        schemes.forEach((url, index) => {
          setTimeout(() => {
            if (!attempted) {
              attempted = true;
              window.location.href = url;
            }
          }, index * 500); // give some breathing room between attempts
        });

        // Reveal fallback if nothing happened
        fallbackTimer = setTimeout(() => {
          if (!appOpened) {
            showFallback("Couldn’t open the app automatically. Tap below to continue.");
          }
        }, 3000);
      }

      function showFallback(customMessage) {
        const loader = document.getElementById("loader");
        const message = document.getElementById("message");
        const fallback = document.getElementById("fallback");
        const fallbackText = document.getElementById("fallbackText");
        if (loader) loader.classList.add("hidden");
        if (message) message.textContent = customMessage || "Having trouble opening the app? Try the manual option below.";
        if (fallback) fallback.style.display = "block";

        // Manual open
        const manualBtn = document.getElementById("manualOpenBtn");
        if (manualBtn) {
          manualBtn.onclick = function (e) {
            e.preventDefault();
            const fragment = getFragment();
            // Do nothing if invalid — user might have pasted wrong link
            const v = validateFragment(fragment);
            if (!v.ok) {
              if (fallbackText) fallbackText.textContent = v.msg;
              return;
            }
            window.location.href = `foundone://reset-password#${fragment}`;
          };
        }
      }

      // If page becomes hidden, we assume app switched to foreground
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          appOpened = true;
        }
      });

      // Start when page loads
      window.addEventListener("load", tryOpenApp);

      // Optional: one retry when user comes back (e.g., after installing the app)
      window.addEventListener("focus", function () {
        if (!appOpened && retryOnFocus > 0) {
          retryOnFocus -= 1;
          tryOpenApp();
        }
      });
    })();
  </script>
</body>
</html>
